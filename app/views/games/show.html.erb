<p><a href="/games">Back</a></p>
<p>
  <strong>Game id:</strong>
  <%= @game.id %>
</p>

<div id="status">

<div class="main-display text-center">
  <% if current_user.is_game_host? %>
    <div class="btn btn-lg btn-success start-game-btn">Start Game!</div>
  <% end %>
  <%= link_to 'Leave Game!', game_leave_path(@game), class: 'btn btn-lg btn-primary leave-game-btn"' %>
</div>

<!-- display the button only after the scripts have loaded -->
<button id="play_turn" class="btn btn-primary"
	style="display: none">Play a turn</button>
</p>


<!-- game window -->
<div id="game-window" style="height: 550px;">
  <% cards =
  ['attack-1','attack-2','attack-3','attack-4','cat-1','cat-2','cat-3','cat-4',
   'cat-5','cat-6','defuse-1','defuse-2','defuse-3','defuse-4','defuse-5',
   'exploding-kitten-1','exploding-kitten-2','exploding-kitten-3','favor-1',
   'favor-2','future-1','future-2','future-3','nope-1','nope-2','shuffle-1',
   'shuffle-2','shuffle-3','skip-1','skip-2'] %>

  <div id="deck-discard">
    <div id="deck" class="card"><%=image_tag("deck.jpg")%></div>
    <div id="discard" class="card">Discard</div>
  </div>

  <div id="hand" class="cards">
    <% for i in 0...5 %>
      <% card = cards[i] %>
      <%= image_tag(card, :class => "card draggable-card", :id => card) %>
    <% end %>
  </div>
</div>


<!-- chat box -->
<div id="chat-wrapper">
  <div id="menu">
    <p class="welcome">Game #<%= @game.id %> Chat <b></b></p>
    <p class="logout"><a id="exit" href="#">Exit Chat</a></p>
    <div style="clear:both"></div>
  </div>

  <!-- chat text -->
  <div id = "chat">
  	<div id="chatbox"></div>
  </div>

  <div id="txtbox">
  	<!-- send -->
  	<input name="submitmsg" type="submit" id="submitmsg" value="Send" style="float:right"/>

	   <!-- user input -->
  	<div style="overflow: hidden; padding-right: .5em">
      <input name="usermsg" type="text" id="chatbox" autocomplete="off"
             placeholder="Send a message..." maxlength="4000" style="width:100%"
             onkeypress="return pressEnter(event);"/>
    </div>
  </div>
</div>

<% content_for :javascript do %>

<script type="text/javascript">

var cards =
  ['attack-1','attack-2','attack-3','attack-4','cat-1','cat-2','cat-3','cat-4',
   'cat-5','cat-6','defuse-1','defuse-2','defuse-3','defuse-4','defuse-5',
   'exploding-kitten-1','exploding-kitten-2','exploding-kitten-3','favor-1',
   'favor-2','future-1','future-2','future-3','nope-1','nope-2','shuffle-1',
   'shuffle-2','shuffle-3','skip-1','skip-2'];

$(document).ready(function() {
  // cards can be drawn from deck
  $('#deck').click( function() {
    spawn_card();
  });

  // discard pile is droppable
  $('#discard').droppable( {
    accept: '.draggable-card',
    hoverClass: 'hovered',
    drop: handleDropEvent
  });

  $('.draggable-card').draggable( {
    cursor: 'move',
    snap: '#discard',
    containment: '#game-window',
    stack: '.draggable-card'
  });

  $('#game-window').on('click', '.draggable-card', function() {
    $(this).animate({
      height: ($(this).height() == 300) ? 150 : 300,
      width: ($(this).width() == 180) ? 90 : 180
    }, 200);
  });
});

function handleDropEvent( event, ui ) {
  var draggable = ui.draggable;
  alert( 'Card "' + draggable.attr('id') + '" was discarded!' );
  draggable.remove();
}

function spawn_card() { 
  var img = document.createElement("img");
  var card_name = cards[Math.floor(Math.random()*cards.length)];
  img.src = "/assets/" + card_name + '.jpg';
  img.setAttribute("class", "card draggable-card");
  img.setAttribute("id", card_name);
  document.getElementById('hand').appendChild(img);

  $(img).draggable( {
    cursor: 'move',
    snap: '#discard',
    containment: '#game-window',
    stack: '.draggable-card'
  });
}

</script>

  <script>
    $(function(){
      // Enable pusher logging - don't include this in production
      Pusher.log = function(message) {
        if (window.console && window.console.log) {
          window.console.log(message);
        }
      };

        var gameChannel = pusher.subscribe('<%= @main_channel %>');
        var userChannel = pusher.subscribe('<%= @user_channel %>');

         // listen for pusher events from server
        gameChannel.bind('player.joined', function(data) {
          alert('User '+ data.username + ' joined the game!');
        });

        gameChannel.bind('game.start', function(data) {
          if (data.error) alert(data.error);
          console.log(data);
        });

        userChannel.bind('player.turn.start', function() {
          alert('your turn!');
        });

        userChannel.bind('player.hand.updated', function(data) {
          console.log('Hand updated!');
          console.log(data);
        });


        // DOM events
        <% if current_user.is_game_host? %>
          $('.start-game-btn').click(function() {
            var headers = {};
            headers['X-CSRF-Token'] = AUTH_TOKEN;

            $.ajax({
              method: 'POST',
              url: '<%= game_start_path(@game) %>',
              headers: headers
            });
          });
        <% end %>

        $('button#play_turn').click(function() {
      	var URI = '/games/play_turn';
      	var payload = {
      		game_id: "<%= @game.id %>",
      		user_id: <%= current_user.id %>,
      		username: "<%= current_user.username %>"
      	}
      	$.post(URI,payload,function(response) {
      		console.log(response);
      	});
      });

      $('button#play_turn').show();

      $('input#submitmsg').click(function() {
      	console.log("clicked");
      	if(!input_is_empty()) {
      		console.log("not empty");
      		var URI = '/chat/message';
      		var message = $('input#chatbox').val();
      		var payload = {
      			message: message,
      			game_id: <%= @game.id %>,
      			username: "<%= current_user.username %>"
      		}
      		$.post(URI,payload,function(response) {
      			console.log(response);
      		});
      		$('input#chatbox').val("");
      	}
      });
    });
  </script>

  <script>
    function pressEnter(e) {
        // window.event has the event for some browsers where it isn't passed (IE)
        e = e || window.event;
        if (event.keyCode == 13) {
        	// press submit button on Enter key press
            document.getElementById('submitmsg').click();
            return false;
        }
        return true;
    }
  </script>
<% end %>
