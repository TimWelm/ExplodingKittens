<p><a href="/games">Back</a></p>
<p>
  <strong>Game id:</strong>
  <%= @game.id %>
</p>

<div id="status">

<div class="main-display text-center">

  <% if current_user.is_game_host? %>
    <div class="text-center">
      <div class="btn btn-lg btn-success start-game-btn">Start Game!</div>
    </div>
  <% end %>
</div>

<!-- display the button only after the scripts have loaded -->
<button id="play_turn" class="btn btn-primary"
	style="display: none">Play a turn</button>
</p>

<!-- chat box -->
<div id="chat-wrapper">
  <div id="menu">
    <p class="welcome">Game #<%= @game.id %> Chat <b></b></p>
    <p class="logout"><a id="exit" href="#">Exit Chat</a></p>
    <div style="clear:both"></div>
  </div>

  <!-- chat text -->
  <div id = "chat">
  	<div id="chatbox"></div>
  </div>

  <div id="txtbox">
  	<!-- send -->
  	<input name="submitmsg" type="submit" id="submitmsg" value="Send" style="float:right"/>

	   <!-- user input -->
  	<div style="overflow: hidden; padding-right: .5em">
      <input name="usermsg" type="text" id="chatbox" autocomplete="off"
             placeholder="Send a message..." maxlength="4000" style="width:100%"
             onkeypress="return pressEnter(event);"/>
    </div>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    $(function(){
      // Enable pusher logging - don't include this in production
      Pusher.log = function(message) {
        if (window.console && window.console.log) {
          window.console.log(message);
        }
      };

      var channelName = "<%= @pusher_channel %>";

      pusher.unsubscribe(channelName); // clears duplicate msgs
      var channel = pusher.subscribe(channelName);

        // listen for pusher events from server
        channel.bind('user.joined', function(data) {
          alert('User '+ data.username + ' joined the game!');
        });

        channel.bind('game.start', function(data) {
          console.log(data);
        });

        // DOM events
        <% if current_user.is_game_host? %>
          $('.start-game-btn').click(function() {
            var headers = {};
            headers['X-CSRF-Token'] = AUTH_TOKEN;

            $.ajax({
              method: 'POST',
              url: '<%= game_start_path(@game) %>',
              headers: headers
            });
          });
        <% end %>

        $('button#play_turn').click(function() {
      	var URI = '/games/play_turn';
      	var payload = {
      		game_id: "<%= @game.id %>",
      		user_id: <%= current_user.id %>,
      		username: "<%= current_user.username %>"
      	}
      	$.post(URI,payload,function(response) {
      		console.log(response);
      	});
      });

      $('button#play_turn').show();

      $('input#submitmsg').click(function() {
      	console.log("clicked");
      	if(!input_is_empty()) {
      		console.log("not empty");
      		var URI = '/chat/message';
      		var message = $('input#chatbox').val();
      		var payload = {
      			message: message,
      			game_id: <%= @game.id %>,
      			username: "<%= current_user.username %>"
      		}
      		$.post(URI,payload,function(response) {
      			console.log(response);
      		});
      		$('input#chatbox').val("");
      	}
      });
    });
  </script>

  <script>
    function pressEnter(e) {
        // window.event has the event for some browsers where it isn't passed (IE)
        e = e || window.event;
        if (event.keyCode == 13) {
        	// press submit button on Enter key press
            document.getElementById('submitmsg').click();
            return false;
        }
        return true;
    }
  </script>
<% end %>
